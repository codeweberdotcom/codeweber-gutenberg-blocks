# Рефакторинг · Чек-лист безопасности

## 1. Когда требуется рефакторинг
- Блок/модуль сложно поддерживать (дублирование, неочевидные зависимости).
- Нужно обновить API Gutenberg или WordPress (например, `InnerBlocks`, `Block Supports`).
- Требуется улучшить производительность (меньше ассетов, lazy-loading данных).

## 2. Подготовка
1. Зафиксировать текущее поведение (скриншоты редактор + фронт, экспорт блоков через `Copy all content`).
2. Создать план миграции:
   - какие файлы затрагиваем,
   - какие версии блоков будут `deprecated`,
   - как обновим локализации и PHP-обёртки.
3. Проверить совместимость с другими плагинами CodeWeber (темы, шорткоды).

## 3. Выполнение
- Работать небольшими коммитами: JS/SCSS/PHP отдельно.
- Если меняем структуру атрибутов:
  - добавить `deprecated` секцию,
  - написать мигратор в `deprecated.save`.
- Обновить `block.json` так, чтобы не ломать сохранённые блоки (не удаляем обязательные атрибуты без fallback).
- В PHP очищаем legacy-хуки только после того, как убедились, что блок не зависит от них.

## 4. Тесты и обратная совместимость
- Создать тестовую страницу с миксом старых и новых блоков.
- Проверить экспорт/импорт шаблонов (Reusable/Pattern).
- Включить/выключить плагин: убедиться, что сайт не падает, даже если блоки сохранены в контенте.
- Если менялись REST endpoинты — обновить `settings/api/*` и протестировать роли/permissions.

## 5. Документация и релиз
- Описать изменения в `doc/` (что поменялось, почему, как мигрировать).
- Добавить раздел в `GUTENBERG_BLOCK_STANDARDS.md`, если блок получил особые правила.
- Обновить `Readme.md` или changelog (кратко: Added, Changed, Deprecated).
- Перед релизом прогнать полный набор скриптов: `npm run lint:js`, `npm run lint:css`, `npm run build`, `node generate-pot.js`.

## 6. Post-release наблюдение
- Проверить `debug.log` на стендах.
- Убедиться, что редактор не кидает `Block validation failed` при вставке существующих блоков.
- Если заметили несовместимости — описать hotfix-план и добавить задачу в backlog.

